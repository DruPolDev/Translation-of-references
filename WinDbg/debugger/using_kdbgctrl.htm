<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="Using KDbgCtrl"/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Using KDbgCtrl</title>

<meta name="MS-HAID" content="r02~a_setup_1a_eecafec5-45df-4944-8b73-c27a452f33db.xml"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="debugger.using_kdbgctrl"></a>Using KDbgCtrl</h1>
</div>
<p>The KDbgCtrl (Kernel Debugging Control, kdbgctrl.exe) tool can be used to control the kernel debugging connection from the target computer.</p>
<p>To use this tool, your target computer must be running Windows Server 2003 or a later version of Windows.</p>
<p>KDbgCtrl can control five different settings: Full Kernel Debugging, Automatic Kernel Debugging, User-Mode Error Handling, Blocking of Kernel Debugging, and the size of the DbgPrint buffer.</p>
<p>To use KDbgCtrl, you must have already enabled kernel debugging in the boot settings of the target computer before the last boot. KDbgCtrl cannot be used to enable kernel debugging if this was not done.  See Boot Parameters to Enable Debugging  for details on these boot settings.</p>
<h3><a id="full_kernel_debugging"></a><a id="FULL_KERNEL_DEBUGGING"></a>Full Kernel Debugging</h3>
<p>When Full Kernel Debugging is enabled, a kernel debugger running on the host computer can break into the target computer. The target computer will break into the kernel debugger if a kernel-mode exception is hit. Messages from the target to the host, such as <b>DbgPrint</b> output, symbol load messages, and redirected user-mode debuggers, are also allowed.</p>
<p>If this setting is disabled, all signals from the host computer will be ignored by the target.</p>
<p>Full Kernel Debugging is enabled by default. To check the current setting value, use <b>kdbgctrl -c</b>. To disable this setting, use <b>kdbgctrl -d</b>. To enable this setting, use <b>kdbgctrl -e</b>.</p>
<p>If you wish to check the current setting and use it to control execution within a batch file, you can use the <b>kdbgctrl -cx</b> command. For details on this command, see <a href="kdbgctrl_command_line_options.htm"><b>KDbgCtrl Command-Line Options</b></a>.</p>
<h3><a id="automatic_kernel_debugging"></a><a id="AUTOMATIC_KERNEL_DEBUGGING"></a>Automatic Kernel Debugging</h3>
<p>If Full Kernel Debugging is enabled, the current setting for Automatic Kernel Debugging is immaterial -- all communication is permitted.</p>
<p>When Full Kernel Debugging is disabled and Automatic Kernel Debugging is enabled, only the target computer can initiate a debugging connection.</p>
<p>In this case, only a kernel-mode exception, breakpoint, or other kernel-mode event will cause a connection to be established. The connection will not be established for <b>DbgPrint</b> output, symbol load messages, redirected user-mode debugger input and output, or other similar messages -- these will be stored in the DbgPrint buffer instead of being sent to the kernel debugger.</p>
<p>If an exception or event causes the target to break into the kernel debugger, then Full Kernel Debugging will be automatically turned on, just as if you had executed <b>kdbgctrl -e</b>.</p>
<p>Automatic Kernel Debugging is disabled by default (although this is immaterial unless Full Kernel Debugging is disabled as well). To check the current setting value, use <b>kdbgctrl -ca</b>. To disable this setting, use <b>kdbgctrl -da</b>. To enable this setting, use <b>kdbgctrl -ea</b>.</p>
<h3><a id="user_mode_error_handling"></a><a id="USER_MODE_ERROR_HANDLING"></a>User-Mode Error Handling</h3>
<p>When User-Mode Error Handling is enabled, some user-mode events will cause the target computer to break into the kernel debugger. </p>
<p>Specifically, all <b>int 3</b> interrupts -- such as breakpoints inserted into the code by a debugger or calls to<b> DbgBreakPoint</b> -- will cause a break into the kernel debugger. However, standard exceptions -- such as access violations and division by zero -- will usually not be sent to the kernel debugger.</p>
<p>If a user-mode debugger is already attached to the process, this debugger will capture all user-mode errors, and the kernel debugger will not be alterted. For the precedence ranking of the various user-mode error handlers, see <a href="enabling_postmortem_debugging.htm">Enabling Postmortem Debugging</a>.</p>
<p>For User-Mode Error Handling to function, either Full Kernel Debugging or Automatic Kernel Debugging must be enabled as well.</p>
<p>User-Mode Error Handling is enabled by default. To check the current setting value, use <b>kdbgctrl -cu</b>. To disable this setting, use <b>kdbgctrl -du</b>. To enable this setting, use <b>kdbgctrl -eu</b>.</p>
<h3><a id="blocking_kernel_debugging"></a><a id="BLOCKING_KERNEL_DEBUGGING"></a>Blocking Kernel Debugging</h3>
<p>In some cases you might want to set up the target computer for kernel debugging, but wait to enable kernel debugging until after the target computer is started. You can do that by blocking kernel debugging.</p>
<p>To block kernel debugging, set up the target computer by using commands similar to the following:</p>
<pre class="syntax" xml:space="preserve"><code>bcdedit /debug on
bcdedit /dbgsettings 1394 channel:32 /start DISABLE /noumex</code></pre>
<p>When you restart the target computer, it will be prepared for kernel debugging, but kernel debugging and User-Mode Error Handling will be disabled. At that point, a host computer will not be able to attach to the target computer, bug checks will not be caught by the kernel debugger, and user-mode exceptions will not cause a break in to the kernel debugger.</p>
<p>When you are ready, you can enable kernel debugging (without restarting the target computer) by entering the following commands.</p>
<pre class="syntax" xml:space="preserve"><code>kdbgctrl -db
kdbgctrl -e</code></pre>
<p>Later, you can disable kernel debugging by entering the following commands.</p>
<pre class="syntax" xml:space="preserve"><code>kdbgctrl -d
kdbgctrl -eb</code></pre>
<p>You can use <b>kdbgctrl -cb</b> to check whether kernel debugging is blocked.</p>
<h3><a id="the_dbgprint_buffer_size"></a><a id="THE_DBGPRINT_BUFFER_SIZE"></a>The DbgPrint Buffer Size</h3>
<p>The DbgPrint buffer stores messages that the target computer has sent to the kernel debugger.</p>
<p>If Full Kernel Debugging is enabled, these messages will automatically appear in the kernel debugger. But if this option is disabled, these messages will be stored in the buffer. At a later point in time, you can enable kernel debugging, connect to a kernel debugger, and use the <a href="_dbgprint.htm"><b>!dbgprint</b></a> extension to see the contents of this buffer. For more information about this buffer, see The DbgPrint Buffer.</p>
<p>The default size of the DbgPrint buffer is 4 KB on a free build of Windows, and 32 KB on a checked build of Windows. To determine the current buffer size, use <b>kdbgctrl -cdb</b>. To change the buffer size, use <b>kdbgctrl -sdb</b><i>Size</i>, where <i>Size</i> specifies the new buffer size. For syntax details, see <a href="kdbgctrl_command_line_options.htm"><b>KDbgCtrl Command-Line Options</b></a>.</p>
<h3><a id="examples"></a><a id="EXAMPLES"></a>Examples</h3>
<p>To display all the current settings, use the following command:</p>
<div class="code"><span codelanguage=""><table>
<tr>
<th></th>
</tr>
<tr>
<td>
<pre>kdbgctrl -c -ca -cu -cb -cdb </pre>
</td>
</tr>
</table></span></div>
<p>To restore the default settings, use the following command:</p>
<div class="code"><span codelanguage=""><table>
<tr>
<th></th>
</tr>
<tr>
<td>
<pre>kdbgctrl -e -da -eu -db -sdb 0x1000 </pre>
</td>
</tr>
</table></span></div>
<p>To lock out the host computer so that it only is contacted on exceptions, use the following command:</p>
<div class="code"><span codelanguage=""><table>
<tr>
<th></th>
</tr>
<tr>
<td>
<pre>kdbgctrl -d -ea -eu </pre>
</td>
</tr>
</table></span></div>
<p>To disable all kernel debugging, use the following command:</p>
<div class="code"><span codelanguage=""><table>
<tr>
<th></th>
</tr>
<tr>
<td>
<pre>kdbgctrl -d -da </pre>
</td>
</tr>
</table></span></div>
<p>If you are disabling all kernel debugging, you may also wish to increase the size of the DbgPrint buffer. This insures that all messages will be saved in case you need to see them later. If you have a megabyte of memory to spare, you might use the following command:</p>
<div class="code"><span codelanguage=""><table>
<tr>
<th></th>
</tr>
<tr>
<td>
<pre>kdbgctrl -sdb 0x100000 </pre>
</td>
</tr>
</table></span></div>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [debugger\debugger]:%20Using KDbgCtrl%20 RELEASE:%20(3/16/2017)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
