<HTML xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:script2="urn:script2" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp" xmlns:ApiRef="http://msdn.microsoft.com/apiref">
<HEAD>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<TITLE>Source Server </TITLE><META NAME="MS-HAID" CONTENT="base.source_server">
<!-- Built on Tuesday, September 25, 2007 -->
<LINK REL="STYLESHEET" TYPE="text/css" HREF="../common/backsdk4.css"/>
<SCRIPT SRC="../common/langref.js"></SCRIPT>
</HEAD>
<BODY TOPMARGIN="0">
<DIV class="clsServerSDKContent">
<H1><A NAME="base.source_server_and_source_indexing"></A>Source Server</H1>
<P>Source server enables a client to retrieve the exact version of the source files that were used to build an application. Because the source code for a module can change between versions and over a course of years, it is important to look at the source code as it existed when the version of the module in question was built.</P>
<P>Source server retrieves the appropriate files from source control. To use source server, the application must have been source indexed.</P>
<H4><A NAME="source_indexing"></A>Source Indexing</H4>
<P>The source indexing system is a collection of executable files and Perl scripts. The Perl scripts require Perl 5.6 or greater.</P>
<P>Generally, binaries are source indexed during the build process after the application has been built. The information needed by source server is stored in the PDB files. Source server currently supports the following source-control systems: Perforce and Visual SourceSafe. You can also create a custom script to index your code for a different source-control system.</P>
<P>The following table lists the source server tools.</P>
<TABLE CLASS="clsStd">
<TR>
<TH>Tool</TH>
<TH>Description</TH>
</TR>
<TR>
<TD>Srcsrv.ini</TD>
<TD>This file is the master list of all source control servers. Each entry has the following format:<P><i>MYSERVER</i>=<i>serverinfo</i></P>
<P>When using Perforce, the server info consists of the full network path to the server, followed by a colon, followed by the port number it uses. For example:</P>
<P>MYSERVER=machine.corp.company.com:1666</P>
<P>This file can be installed on the computer running the debugger. When source server starts, it looks at Srvsrc.ini for values; these values will override the information contained in the PDB file. This enables users to configure a debugger to use an alternate source control server at debug time.</P>
<P>For more information, see the example Srcsrv.ini installed with the source server tools.</P>
</TD>
</TR>
<TR>
<TD>Ssindex.cmd </TD>
<TD>This script builds the list of files checked into source control along with the version information of each file. It stores a subset of this information in the .pdb files generated when you built the application. The script uses one of the following Perl modules to interface with source control: P4.pm (Perforce) or Vss.pm (Visual Source Safe).<P>For more information, run the script with the -? or -?? (verbosed help) option or examine the script.</P>
</TD>
</TR>
<TR>
<TD>Srctool.exe</TD>
<TD>This utility lists all files indexed within a .pdb file. For each file, it lists the full path, source control server, and version number of the file. You can use this information to retrieve files without using the source server.<P>For more information, run the utility with the /? option.</P>
</TD>
</TR>
<TR>
<TD>Pdbstr.exe</TD>
<TD>This utility is used by the indexing scripts to insert the version control information into the "srcsrv" alternate stream of the target .pdb file. It can also read any stream from a .pdb file. You can use this information to verify that the indexing scripts are working properly.<P>For more information, run the utility with the /? option.</P>
</TD>
</TR>
</TABLE>
<H4><A NAME="retrieving_the_source_file"></A>Retrieving the Source File</H4>
<P>The DbgHelp API provides access to source server functionality through the <A HREF="symgetsourcefile.htm"><b>SymGetSourceFile</b></A> function. To retrieve the name of the source file to be retrieved, call the <A HREF="symenumsourcefiles.htm"><b>SymEnumSourceFiles</b></A> or <A HREF="symgetlinefromaddr64.htm"><b>SymGetLineFromAddr64</b></A> function.</P>
<H4><A NAME="using_source_server_with_a_debugger"></A>Using Source Server with a Debugger</H4>
<P>To use the source server with WinDbg, KD, NTSD, or CDB, ensure that you have installed a recent version of the Debugging Tools for Windows package (version 6.3 or later). Then, include srv* in the .srcpath command as follows:</P>
<P><b>.srcpath srv*;</b><i>c:\mysource</i></P>
<P>Note that this example also includes a traditional source path. If the debugger cannot retrieve the file from the source server, it will search the specified path.</P>
<P>If a source file is retrieved by the source server, it will remain on your hard drive after the debugging session is over. Source files are stored locally in the src subdirectory of the Debugging Tools for Windows installation directory.</P>
<H4><A NAME="source_server_data_blocks"></A>Source Server Data Blocks</H4>
<P>Source server relies on two blocks of data within the PDB file.<P></P>
<ul>
<li>Source file list. Building a module automatically creates a list of fully-qualified paths to the source files used to build the module.</li>
<li>Data block. Indexing the source as described previously adds an alternate stream to the PDB file named "srcsrv". The script that inserts this data is dependent on the specific build process and source control system in use.</li>
</ul>
</P>
<P>In the language specification version 1, the data block is divided into three sections: ini, variables, and source files. It has the following syntax.</P>
<P></P><DIV class="codeSnippet"><PRE xml:space="preserve">SRCSRV: ini ------------------------------------------------ 
VERSION=1
VERCTRL=&lt;source_control_str&gt;
DATETIME=&lt;date_time_str&gt;
SRCSRV: variables ------------------------------------------ 
SRCSRVTRG=%sdtrg% 
SRCSRVCMD=%sdcmd% 
SRCSRVENV=var1=string1\bvar2=string2 
DEPOT=//depot 
SDCMD=sd.exe -p %fnvar%(%var2%) print -o %srcsrvtrg% -q %depot%/%var3%#%var4%
SDTRG=%targ%\%var2%\%fnbksl%(%var3%)\%var4%\%fnfile%(%var1%) 
WIN_SDKTOOLS= sserver.microsoft.com:4444 
SRCSRV: source files --------------------------------------- 
&lt;path1&gt;*&lt;var2&gt;*&lt;var3&gt;*&lt;var4&gt; 
&lt;path2&gt;*&lt;var2&gt;*&lt;var3&gt;*&lt;var4&gt; 
&lt;path3&gt;*&lt;var2&gt;*&lt;var3&gt;*&lt;var4&gt; 
&lt;path4&gt;*&lt;var2&gt;*&lt;var3&gt;*&lt;var4&gt; 
SRCSRV: end ------------------------------------------------</PRE></DIV>
<P>All text is interpreted literally, except for text enclosed in percent signs (%). Text enclosed in percent signs is treated as a variable name to be resolved recursively, unless it is one of the following functions:</P>
<P></P>
<DL>
<DT>%fnvar%()</DT>
<DD><p>The parameter text should be enclosed in percent signs and treated as a variable to be expanded. </p>
</DD>
<DT>%fnbksl%()</DT>
<DD><p>All forward slashes (/) in the parameter text should be replaced with backward slashes (\).</p>
</DD>
<DT>%fnfile%()</DT>
<DD><p>All path information in the parameter text should be stripped out, leaving only the file name.</p>
</DD>
</DL>
<P>The ini section contains variables that describe the requirements. The indexing script can add any number of variables to this section. The following are examples:</P>
<P></P>
<DL>
<DT>VERSION</DT>
<DD><p>The language specification version. This variable is required.</p>
</DD>
<DT>VERCTL</DT>
<DD><p>A string that describes the source control product. This variable is optional.</p>
</DD>
<DT>DATETIME</DT>
<DD><p>A string that indicates the date and time the PDB file was processed. This variable is optional.</p>
</DD>
</DL>
<P>The variables section contains variables that describe how to extract a file from source control. It can also be used to define commonly used text as variables to reduce the size of the data block.</P>
<P></P>
<DL>
<DT>SRCSRVTRG</DT>
<DD><p>Describes how to build the target path for the extracted file. This is a required variable.</p>
</DD>
<DT>SRCSRVCMD</DT>
<DD><p>Describes how to build the command to extract the file from source control. This includes the name of the executable file and its command-line parameters. This is a required variable.</p>
</DD>
<DT>SRCSRVENV</DT>
<DD><p>A string that lists environment variables to be created during the file extraction. Separate multiple entries with a backspace character (\b). This is an optional variable.</p>
</DD>
</DL>
<P>The source files section contains an entry for each source file that has been indexed. The contents of each line are interpreted as variables with the names VAR1, VAR2, VAR3, and so on until VAR10. The variables are separated by asterisks. VAR1 must specify the fully-qualified path to the source file as listed elsewhere in the PDB file. For example, the following line: </P>
<P></P><DIV class="codeSnippet"><PRE xml:space="preserve">c:\proj\src\file.cpp*TOOLS_PRJ*tools/mytool/src/file.cpp*3</PRE></DIV>
<P>is interpreted as follows:</P>
<P></P><DIV class="codeSnippet"><PRE xml:space="preserve">VAR1=c:\proj\src\file.cpp
VAR2=TOOLS_PRJ
VAR3=tools/mytool/src/file.cpp
VAR4=3</PRE></DIV>
<P>In this example, VAR4 is a version number. However, most source control systems support labeling files in such a way that the source state for a given build can be restored. Therefore, you could alternately use the label for the build. The sample data block could be modified to contain a variable such as the following:</P>
<P></P>
<DIV class="codeSnippet">
<PRE xml:space="preserve">LABEL=BUILD47</PRE></DIV>
<P>Then, presuming the source control system uses the at sign (@) to indicate a label, you could modify the SRCSRVCMD variable as follows:</P>
<p><b>sd.exe -p %fnvar%(%var2%) print -o %srcsrvtrg% -q %depot%/%var3%@%label%</b></p>
<H4><A NAME="how_source_server_works"></A>How Source Server Works</H4>
<P>The source server client is implemented in Symsrv.dll. The client does not extract information directly from the PDB file; it uses a symbol handler such as the one implemented in Dbghelp.dll. It is essentially a recursive variable substitution engine that creates a command line that can be used to extract the proper source file from the source control system. Your code should not call Symsrv.dll directly. To integrate its functionality into your application, use the <A HREF="symgetsourcefile.htm"><b>SymGetSourceFile</b></A> function.</P>
<P><p>The first version of source server works as follows. This behavior may change in future versions.</p>
</P>
<ul>
<li>The client calls the <A><b>SrcSrvInit</b></A> function with the target path to be used as a base for all source file extractions. It stores this path in the TARG variable.</li>
<li>The client extracts the Srcsrv stream from the PDB when the module PDB is loaded and calls the <A><b>SrcSrvLoadModule</b></A> function to pass the data block to source server.</li>
<li>When Dbghelp retrieves a source file, the client calls the <A><b>SrcSrvGetFile</b></A> function to retrieve the source files from source control.</li>
<li>Source server searches the source file entries in the data block for an entry with that matches the requested file. It fills VAR1 to VAR<i>n</i> with the contents of the source file entry. Next, it expands the SRCSRVTRG variable using VAR1 to VAR<i>n</i>. If the file is already in this location, it returns the location to the caller. Otherwise, it expands the SRCSRVCMD variable to build the command needed to retrieve the file from source control and copy it to the target location. Finally, it executes this command.</li>
</ul>
<H4><A NAME="creating_a_source_control_provider_module"></A>Creating a Source Control Provider Module</H4>
<P>The source server includes provider modules for Perforce (p4.pm) and Visual Source Safe (vss.pm). To create your own provider module, you must implement the following set of interfaces.</P>
<P></P>
<DL>
<DT><A><b>$module::SimpleUsage()</b></A></DT>
<DD><p>Purpose: Displays simple module usage information to STDOUT.
</p>
<P>Parameters: None</P>
<P>Return value: None</P>
</DD>
<DT><A><b>$module::VerboseUsage()</b></A></DT>
<DD><p>Purpose: Displays in-depth module usage information to STDOUT.</p>
<P>Parameters: None</P>
<P>Return value: None</P>
</DD>
<DT><A><b>$objref = $module::new(@CommandArguments)</b></A></DT>
<DD><p>Purpose: Initializes an instance of the provider module.</p>
<P>Parameters: All @ARGV arguments that weren't recognized by SSIndex.cmd as being general arguments.</P>
<P>Return value: A reference that can be used in later operations.</P>
</DD>
<DT><A><b>$objref-&gt;GatherFileInformation($SourcePath, $ServerHashReference)</b></A></DT>
<DD><p>Purpose: Enables the module to gather the required source indexing information for the directory specified by the $SourcePath parameter.  The module should not assume that this entry will be called only once for each object instance, as SSIndex.cmd may call it multiple times for different paths.</p>
<P>Parameters: (1) The local directory containing the source to be indexed.  (2) A reference to a hash containing all of the entries from the specified Srcsrv.ini file.  </P>
<P>Return value: None</P>
</DD>
<DT><A><b>($VariableHashReference, $FileEntry) = $objref-&gt;GetFileInfo($LocalFile)</b></A></DT>
<DD><p>Purpose: Provides the necessary information to extract a single, specific file from the source control system.</p>
<P>Parameters: A fully-qualified file name</P>
<P>Return value: (1) A hash reference of the variables necessary to interpret the returned $FileEntry.  SSIndex.cmd caches these variables for every source file used by a single debug file to reduce the amount of information written to the source index stream. (2) The file entry to be written to the source index stream to allow SrcSrv.dll to extract this file from source control.  The exact format of this line is specific to the source control system.</P>
</DD>
<DT><A><b>$TextString = $objref-&gt;LongName()</b></A></DT>
<DD><p>Purpose: Provides a descriptive string to identify the source control provider to the end user.</p>
<P>Parameters: None</P>
<P>Return value: The descriptive name of the source control system.</P>
</DD>
<DT><A><b>@StreamVariableLines = $objref-&gt;SourceStreamVariables()</b></A></DT>
<DD><p>Purpose: Enables the source control provider to add source control specific variables to the source stream for each debug file. The sample modules use this method for writing the required EXTRACT_CMD and EXTRACT_TARGET variables.</p>
<P>Parameters: None</P>
<P>Return value: The list of entries for the source stream variables.</P>
</DD>
</DL><br><P><A HREF="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [base]:%20Source Server%20 RELEASE:%20(9/25/2007)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AThe SDK team uses the feedback submitted to improve the SDK documentation. We do not use your e-mail address for any other purpose. We will remove your e-mail address from our system after the issue you are reporting has been resolved. While we are working to resolve this issue, we may send you an e-mail message to request more information about your feedback. After the issues have been addressed, we may send you an e-mail message to let you know that your feedback has been addressed.%0A%0AFor more information about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." TITLE="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft
       </A></P>
<P STYLE="font-family: Verdana,sans-serif;font-size:8pt">Build date: 9/25/2007</P>
</DIV>
<DIV CLASS="footer"><P>&nbsp;</P></DIV>
<P style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&copy;&nbsp;2007 Microsoft Corporation. All rights reserved.</P>
</BODY>
</HTML>
